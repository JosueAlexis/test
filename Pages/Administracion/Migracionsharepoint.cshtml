@page
@model ProyectoRH2025.Pages.Administracion.MigracionSharePointModel
@{
    ViewData["Title"] = "Migración de Imágenes a SharePoint";
}

<style>
    .migration-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

        .stat-item:last-child {
            border-bottom: none;
        }

    .stat-label {
        font-weight: 500;
        opacity: 0.9;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
    }

    .control-panel {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
    }

    .migration-progress {
        display: none;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
    }

        .migration-progress.active {
            display: block;
        }

    .progress {
        height: 30px;
        border-radius: 15px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.3);
    }

    .progress-bar {
        font-size: 14px;
        font-weight: bold;
        line-height: 30px;
        transition: width 0.6s ease;
    }

    .log-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }

    .log-entry {
        padding: 8px;
        margin-bottom: 5px;
        border-radius: 5px;
        animation: slideIn 0.3s ease;
    }

    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .log-success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
    }

    .log-error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
    }

    .log-info {
        background: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
    }

    .log-warning {
        background: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
    }

    .btn-migrate {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: white;
        padding: 15px 40px;
        font-size: 1.1rem;
        border-radius: 50px;
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        transition: all 0.3s ease;
    }

        .btn-migrate:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-migrate:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

    .filter-options {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .alert-custom {
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .spinner-border {
        width: 20px;
        height: 20px;
        border-width: 2px;
    }
</style>

<div class="migration-container">
    @Html.AntiForgeryToken()

    <!-- ENCABEZADO -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-cloud-upload-alt me-2"></i>@ViewData["Title"]</h1>
        <a asp-page="/Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Volver
        </a>
    </div>

    <!-- ESTADÍSTICAS -->
    <div class="stats-card">
        <h4 class="mb-4"><i class="fas fa-chart-bar me-2"></i>Estadísticas de Migración</h4>
        <div class="row">
            <div class="col-md-3">
                <div class="stat-item">
                    <span class="stat-label">Total Imágenes</span>
                    <span class="stat-value" id="totalImagenes">@Model.TotalImagenes</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <span class="stat-label">Pendientes</span>
                    <span class="stat-value text-warning" id="pendientes">@Model.ImagenesPendientes</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <span class="stat-label">Migradas</span>
                    <span class="stat-value text-success" id="migradas">@Model.ImagenesMigradas</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <span class="stat-label">Tamaño Total</span>
                    <span class="stat-value" id="tamanoTotal">@Model.TamanoTotalMB MB</span>
                </div>
            </div>
        </div>
    </div>

    <!-- MENSAJES -->
    @if (!string.IsNullOrEmpty(Model.MensajeExito))
    {
        <div class="alert alert-success alert-custom">
            <i class="fas fa-check-circle me-2"></i>@Model.MensajeExito
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.MensajeError))
    {
        <div class="alert alert-danger alert-custom">
            <i class="fas fa-exclamation-triangle me-2"></i>@Model.MensajeError
        </div>
    }

    <!-- PANEL DE CONTROL -->
    <div class="control-panel">
        <h4 class="mb-4"><i class="fas fa-cogs me-2"></i>Configuración de Migración</h4>

        <form id="formMigracion" method="post" asp-page-handler="IniciarMigracion">
            @Html.AntiForgeryToken()

            <div class="filter-options">
                <h6 class="mb-3"><i class="fas fa-filter me-2"></i>Filtros de Migración</h6>

                <div class="row g-3">
                    <!-- RANGO DE FECHAS -->
                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="fas fa-calendar-alt me-1"></i>Fecha Inicio
                        </label>
                        <input type="date"
                               class="form-control"
                               name="FechaInicio"
                               value="@(Model.FechaInicio?.ToString("yyyy-MM-dd") ?? "")"
                               max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="fas fa-calendar-check me-1"></i>Fecha Fin
                        </label>
                        <input type="date"
                               class="form-control"
                               name="FechaFin"
                               value="@(Model.FechaFin?.ToString("yyyy-MM-dd") ?? "")"
                               max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                    </div>

                    <!-- TAMAÑO DE LOTE -->
                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="fas fa-layer-group me-1"></i>Tamaño de Lote
                        </label>
                        <select class="form-select" name="TamanoLote">
                            <option value="10">10 imágenes por lote (Prueba)</option>
                            <option value="50" selected>50 imágenes por lote (Recomendado)</option>
                            <option value="100">100 imágenes por lote (Rápido)</option>
                            <option value="200">200 imágenes por lote (Muy Rápido)</option>
                        </select>
                        <small class="text-muted">Lotes más grandes = más rápido, pero mayor riesgo de errores</small>
                    </div>

                    <!-- SOLO PENDIENTES -->
                    <div class="col-md-6">
                        <label class="form-label d-block">
                            <i class="fas fa-filter me-1"></i>Opciones de Migración
                        </label>
                        <div class="form-check mt-3">
                            <input type="checkbox" class="form-check-input" name="SoloPendientes" id="soloPendientes" checked>
                            <label class="form-check-label" for="soloPendientes">
                                Solo migrar imágenes pendientes (no migradas)
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="SobreescribirExistentes" id="sobreescribir">
                            <label class="form-check-label" for="sobreescribir">
                                Sobrescribir imágenes ya migradas (Re-migración)
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BOTONES DE ACCIÓN -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div>
                    <button type="button" class="btn btn-outline-primary me-2" onclick="actualizarEstadisticas()">
                        <i class="fas fa-sync-alt me-1"></i>Actualizar Estadísticas
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="verificarConexionSharePoint()">
                        <i class="fas fa-network-wired me-1"></i>Probar Conexión SharePoint
                    </button>
                </div>
                <div>
                    <button type="submit" class="btn btn-migrate" id="btnIniciarMigracion">
                        <i class="fas fa-rocket me-2"></i>Iniciar Migración
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- PROGRESO DE MIGRACIÓN -->
    <div class="migration-progress" id="progressContainer">
        <h4 class="mb-3">
            <i class="fas fa-sync-alt fa-spin me-2"></i>Migración en Progreso
        </h4>

        <div class="progress mb-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar"
                 id="progressBar"
                 style="width: 0%">
                0%
            </div>
        </div>

        <div class="row text-center">
            <div class="col-md-3">
                <h6>Procesadas</h6>
                <h3 id="procesadas">0</h3>
            </div>
            <div class="col-md-3">
                <h6>Exitosas</h6>
                <h3 id="exitosas" class="text-success">0</h3>
            </div>
            <div class="col-md-3">
                <h6>Fallidas</h6>
                <h3 id="fallidas" class="text-danger">0</h3>
            </div>
            <div class="col-md-3">
                <h6>Velocidad</h6>
                <h3 id="velocidad">0/min</h3>
            </div>
        </div>
    </div>

    <!-- LOG DE EVENTOS -->
    <div class="control-panel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="fas fa-terminal me-2"></i>Log de Eventos</h4>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limpiarLog()">
                <i class="fas fa-eraser me-1"></i>Limpiar
            </button>
        </div>
        <div class="log-container" id="logContainer">
            <div class="log-entry log-info">
                <i class="fas fa-info-circle me-2"></i>Sistema listo para iniciar migración...
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let migracionActiva = false;
        let intervalActualizacion = null;

        // Configurar formulario
        document.getElementById('formMigracion').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (migracionActiva) {
                alert('Ya hay una migración en progreso');
                return;
            }

            if (!confirm('¿Está seguro de iniciar la migración? Este proceso puede tomar varios minutos.')) {
                return;
            }

            await iniciarMigracion();
        });

        async function iniciarMigracion() {
            try {
                migracionActiva = true;
                document.getElementById('btnIniciarMigracion').disabled = true;
                document.getElementById('progressContainer').classList.add('active');

                agregarLog('info', 'Iniciando proceso de migración...');

                const formData = new FormData(document.getElementById('formMigracion'));
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                const response = await fetch('?handler=IniciarMigracion', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': token
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    agregarLog('success', `Migración iniciada: ${result.mensaje}`);

                    // Iniciar polling para actualizar progreso
                    intervalActualizacion = setInterval(actualizarProgreso, 2000);
                } else {
                    agregarLog('error', `Error: ${result.error}`);
                    finalizarMigracion();
                }
            } catch (error) {
                console.error('Error:', error);
                agregarLog('error', `Error de conexión: ${error.message}`);
                finalizarMigracion();
            }
        }

        async function actualizarProgreso() {
            try {
                const response = await fetch('?handler=ObtenerProgreso');
                const progreso = await response.json();

                if (progreso) {
                    // Actualizar barra de progreso
                    const porcentaje = progreso.porcentaje || 0;
                    document.getElementById('progressBar').style.width = porcentaje + '%';
                    document.getElementById('progressBar').textContent = porcentaje + '%';

                    // Actualizar contadores
                    document.getElementById('procesadas').textContent = progreso.procesadas || 0;
                    document.getElementById('exitosas').textContent = progreso.exitosas || 0;
                    document.getElementById('fallidas').textContent = progreso.fallidas || 0;
                    document.getElementById('velocidad').textContent = (progreso.velocidad || 0) + '/min';

                    // Agregar logs nuevos
                    if (progreso.ultimoLog) {
                        agregarLog(progreso.ultimoLog.tipo, progreso.ultimoLog.mensaje);
                    }

                    // Verificar si terminó
                    if (progreso.completado) {
                        agregarLog('success', '✅ Migración completada exitosamente');
                        finalizarMigracion();
                        await actualizarEstadisticas();
                    }
                }
            } catch (error) {
                console.error('Error actualizando progreso:', error);
            }
        }

        function finalizarMigracion() {
            migracionActiva = false;
            document.getElementById('btnIniciarMigracion').disabled = false;

            if (intervalActualizacion) {
                clearInterval(intervalActualizacion);
                intervalActualizacion = null;
            }
        }

        function agregarLog(tipo, mensaje) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('es-MX');

            const iconos = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${tipo}`;
            logEntry.innerHTML = `<i class="fas ${iconos[tipo]} me-2"></i>[${timestamp}] ${mensaje}`;

            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function limpiarLog() {
            document.getElementById('logContainer').innerHTML = `
                <div class="log-entry log-info">
                    <i class="fas fa-info-circle me-2"></i>Log limpiado - Sistema listo
                </div>
            `;
        }

        async function actualizarEstadisticas() {
            try {
                agregarLog('info', 'Actualizando estadísticas...');

                const response = await fetch('?handler=ActualizarEstadisticas');
                const stats = await response.json();

                if (stats) {
                    document.getElementById('totalImagenes').textContent = stats.total;
                    document.getElementById('pendientes').textContent = stats.pendientes;
                    document.getElementById('migradas').textContent = stats.migradas;
                    document.getElementById('tamanoTotal').textContent = stats.tamanoMB + ' MB';

                    agregarLog('success', 'Estadísticas actualizadas');
                }
            } catch (error) {
                agregarLog('error', 'Error actualizando estadísticas: ' + error.message);
            }
        }

        async function verificarConexionSharePoint() {
            try {
                agregarLog('info', 'Verificando conexión con SharePoint...');

                const response = await fetch('?handler=VerificarConexion');
                const result = await response.json();

                if (result.success) {
                    agregarLog('success', `✅ Conexión exitosa: ${result.mensaje}`);
                } else {
                    agregarLog('error', `❌ Error de conexión: ${result.error}`);
                }
            } catch (error) {
                agregarLog('error', 'Error verificando conexión: ' + error.message);
            }
        }

        // Cargar estadísticas al inicio
        document.addEventListener('DOMContentLoaded', function() {
            agregarLog('info', 'Sistema de migración cargado correctamente');
        });
    </script>
}
