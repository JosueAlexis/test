@page
@model ProyectoRH2025.Pages.Sellos.InventarioCoordinadorModel
@inject ProyectoRH2025.Services.QRCodeService qrService
@{
    ViewData["Title"] = "Inventario - Coordinador";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<div class="container mt-4">
    <h2 class="mb-4">
        <i class="fas fa-box-open text-primary"></i> Inventario de Sellos - Coordinador
    </h2>

    @if (!string.IsNullOrEmpty(Model.Mensaje))
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i> @Model.Mensaje
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.MensajeError))
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-circle me-2"></i> @Model.MensajeError
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- MOSTRAR QR RECIÉN GENERADO -->
    @if (TempData["MostrarQR"] != null)
    {
        var codigoQR = TempData["MostrarQR"].ToString();
        var qrBase64 = qrService.GenerarQRBase64(codigoQR);

        <div class="alert alert-success shadow-lg">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="alert-heading">
                        <i class="fas fa-check-circle"></i> ¡QR Generado Exitosamente!
                    </h4>
                    <p class="mb-2">El código QR ha sido generado. Imprímelo o muéstralo al operador.</p>
                    <hr />
                    <p class="mb-0"><strong>Código:</strong> <code>@codigoQR</code></p>
                </div>
                <div class="col-md-4 text-center">
                    <img src="data:image/png;base64,@qrBase64"
                         alt="Código QR"
                         class="img-fluid"
                         style="max-width: 200px; border: 3px solid #198754; padding: 10px; background: white;" />
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="window.print()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- TABLA DE SELLOS EN TRÁMITE -->
    <div class="card shadow mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
                <i class="fas fa-clock me-2"></i>Sellos en Trámite (Status 4)
                <span class="badge bg-dark float-end">@Model.SellosEnTramite.Count</span>
            </h5>
        </div>
        <div class="card-body">
            @if (Model.SellosEnTramite.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Sello</th>
                                <th>Operador(es)</th>
                                <th>Unidad</th>
                                <th>Ruta</th>
                                <th>Tipo</th>
                                <th>Supervisor</th>
                                <th>Fecha Asignación</th>
                                <th width="200">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.SellosEnTramite)
                            {
                                <tr>
                                    <td class="fw-bold text-primary">@item.Sello?.Sello</td>
                                    <td>
                                        <div>@item.Operador?.Names @item.Operador?.Apellido</div>
                                        @if (item.TipoAsignacion == 1 && item.Operador2 is not null)
                                        {
                                            <small class="text-muted">
                                                <i class="fas fa-user-friends"></i> + @item.Operador2.Names @item.Operador2.Apellido
                                            </small>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">@item.Unidad?.NumUnidad</span>
                                    </td>
                                    <td>@item.Ruta</td>
                                    <td>
                                        <span class="badge bg-info">
                                            @(item.TipoAsignacion == 1 ? "Comboy" : "Individual")
                                        </span>
                                    </td>
                                    <td>
                                        <small>@item.Usuario?.UsuarioNombre</small>
                                    </td>
                                    <td>
                                        <small>@item.Fentrega.ToString("dd/MM/yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-success"
                                                    onclick="entregarSello(@item.id)"
                                                    title="Entregar">
                                                <i class="fas fa-check-circle"></i>
                                            </button>
                                            <button class="btn btn-primary"
                                                    onclick="modificarAsignacion(@item.id)"
                                                    title="Modificar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-5">
                    <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                    <p class="mb-0">No hay sellos en trámite</p>
                </div>
            }
        </div>
    </div>

    <!-- TABLA DE SELLOS EN USO -->
    <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="fas fa-truck me-2"></i>Sellos En Uso (Status 3)
                <span class="badge bg-dark float-end">@Model.SellosEnUso.Count</span>
            </h5>
        </div>
        <div class="card-body">
            @if (Model.SellosEnUso.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Sello</th>
                                <th>Operador(es)</th>
                                <th>Unidad</th>
                                <th>QR Code</th>
                                <th>Fecha Entrega</th>
                                <th>Status Evidencia</th>
                                <th width="250">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.SellosEnUso)
                            {
                                <tr>
                                    <td class="fw-bold text-success">@item.Sello?.Sello</td>
                                    <td>
                                        <div>@item.Operador?.Names @item.Operador?.Apellido</div>
                                        @if (item.TipoAsignacion == 1 && item.Operador2 is not null)
                                        {
                                            <small class="text-muted">
                                                <i class="fas fa-user-friends"></i> + @item.Operador2.Names @item.Operador2.Apellido
                                            </small>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">@item.Unidad?.NumUnidad</span>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary"
                                                onclick="verQR(@item.id)"
                                                title="Ver QR">
                                            <i class="fas fa-qrcode"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <small>@(item.FechaEntrega?.ToString("dd/MM/yyyy HH:mm") ?? "-")</small>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(item.StatusEvidencia))
                                        {
                                            <span class="badge bg-info">@item.StatusEvidencia</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-warning"
                                                    onclick="devolverSello(@item.id)"
                                                    title="Devolver">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                            <button class="btn btn-info"
                                                    onclick="subirEvidencia(@item.id)"
                                                    title="Evidencia">
                                                <i class="fas fa-camera"></i>
                                            </button>
                                            <button class="btn btn-secondary"
                                                    onclick="verEvidencias(@item.id)"
                                                    title="Ver Evidencias">
                                                <i class="fas fa-images"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-5">
                    <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                    <p class="mb-0">No hay sellos en uso</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- MODAL: ENTREGAR SELLO -->
<div class="modal fade" id="modalEntregar" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Confirmar Entrega
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalEntregarBody">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: MODIFICAR ASIGNACIÓN -->
<div class="modal fade" id="modalModificar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Modificar Operador(es)
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-page-handler="ModificarOperador">
                <div class="modal-body">
                    <input type="hidden" id="modIdAsignacion" name="IdAsignacion" />

                    <div class="mb-3">
                        <label class="form-label">Tipo de Asignación</label>
                        <select id="modTipoAsignacion" name="TipoAsignacion" class="form-select">
                            <option value="0">Individual</option>
                            <option value="1">Comboy</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Operador Principal</label>
                        <select id="modOperador1" name="IdOperador" class="form-select operador-select" required></select>
                    </div>

                    <div class="mb-3" id="modOperador2Container" style="display: none;">
                        <label class="form-label">Segundo Operador</label>
                        <select id="modOperador2" name="IdOperador2" class="form-select operador-select"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: VER QR -->
<div class="modal fade" id="modalQR" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-qrcode me-2"></i>Código QR
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="modalQRBody">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: DEVOLVER SELLO -->
<div class="modal fade" id="modalDevolver" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-undo me-2"></i>Devolver Sello
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-page-handler="DevolverSello">
                <div class="modal-body">
                    <input type="hidden" id="devIdAsignacion" name="IdAsignacion" />

                    <div class="mb-3">
                        <label class="form-label">Escanear o Ingresar Código QR</label>
                        <input type="text" name="CodigoQR" class="form-control"
                               placeholder="ASIG-XXX-SELLO-XXX..."
                               required
                               autocomplete="off" />
                        <small class="form-text text-muted">
                            Formato: ASIG-{id}-SELLO-{numero}-OP-{id}-{timestamp}
                        </small>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Importante:</strong> El código QR debe coincidir exactamente con el sello y operador asignados.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-check"></i> Procesar Devolución
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: SUBIR EVIDENCIA -->
<div class="modal fade" id="modalEvidencia" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-camera me-2"></i>Subir Evidencia
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" enctype="multipart/form-data" asp-page-handler="SubirEvidencia">
                <div class="modal-body">
                    <input type="hidden" id="evIdAsignacion" name="IdAsignacion" />

                    <div class="mb-3">
                        <label class="form-label">Tipo de Evidencia</label>
                        <select name="TipoEvidencia" class="form-select" required>
                            <option value="">-- Seleccionar --</option>
                            <option value="Utilizado">✅ Sello Utilizado</option>
                            <option value="Defectuoso">⚠️ Sello Defectuoso</option>
                            <option value="Planta">🏭 Se quedó en Planta</option>
                            <option value="Extraviado">❌ Sello Extraviado</option>
                            <option value="Otro">📝 Otro</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Archivo (Foto/PDF)</label>
                        <input type="file" name="ArchivoEvidencia" class="form-control"
                               accept="image/*,application/pdf" required />
                        <small class="form-text text-muted">
                            Formatos: JPG, PNG, PDF (Máx. 10MB)
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Comentarios</label>
                        <textarea name="Comentarios" class="form-control" rows="3"
                                  placeholder="Describe los detalles de la evidencia..."></textarea>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Nota:</strong> El status del sello se actualizará automáticamente según el tipo de evidencia.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-upload"></i> Subir Evidencia
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: VER EVIDENCIAS -->
<div class="modal fade" id="modalVerEvidencias" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-images me-2"></i>Evidencias Registradas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalVerEvidenciasBody">
                <div class="text-center">
                    <div class="spinner-border text-secondary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ENTREGAR SELLO - Cargar confirmación
        async function entregarSello(idAsignacion) {
            try {
                const response = await fetch(`/Sellos/InventarioCoordinador?handler=ConfirmarEntrega&idAsignacion=${idAsignacion}`);
                const html = await response.text();
                document.getElementById('modalEntregarBody').innerHTML = html;
                new bootstrap.Modal(document.getElementById('modalEntregar')).show();
            } catch (error) {
                Swal.fire('Error', 'No se pudo cargar la información', 'error');
            }
        }

        // MODIFICAR ASIGNACIÓN
        async function modificarAsignacion(idAsignacion) {
            try {
                const response = await fetch(`/Sellos/InventarioCoordinador?handler=ObtenerAsignacion&idAsignacion=${idAsignacion}`);
                const data = await response.json();

                if (data.error) {
                    Swal.fire('Error', data.error, 'error');
                    return;
                }

                document.getElementById('modIdAsignacion').value = idAsignacion;
                document.getElementById('modTipoAsignacion').value = data.tipoAsignacion;

                // 1. Primero cargamos la lista
                await cargarOperadores();

                // 2. Esperamos un momento para asegurar que el DOM se actualizó y luego asignamos valores
                setTimeout(() => {
                    $('#modOperador1').val(data.idOperador).trigger('change');

                    if (data.tipoAsignacion == 1 && data.idOperador2) {
                        $('#modOperador2').val(data.idOperador2).trigger('change');
                        document.getElementById('modOperador2Container').style.display = 'block';
                    } else {
                        document.getElementById('modOperador2Container').style.display = 'none';
                        $('#modOperador2').val('').trigger('change');
                    }
                }, 100);

                new bootstrap.Modal(document.getElementById('modalModificar')).show();
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'No se pudo cargar la información', 'error');
            }
        }

        // VER QR
        async function verQR(idAsignacion) {
            try {
                const response = await fetch(`/Sellos/InventarioCoordinador?handler=VerQR&idAsignacion=${idAsignacion}`);
                const html = await response.text();
                document.getElementById('modalQRBody').innerHTML = html;
                new bootstrap.Modal(document.getElementById('modalQR')).show();
            } catch (error) {
                Swal.fire('Error', 'No se pudo cargar el QR', 'error');
            }
        }

        // DEVOLVER SELLO
        function devolverSello(idAsignacion) {
            document.getElementById('devIdAsignacion').value = idAsignacion;
            new bootstrap.Modal(document.getElementById('modalDevolver')).show();
        }

        // SUBIR EVIDENCIA
        function subirEvidencia(idAsignacion) {
            document.getElementById('evIdAsignacion').value = idAsignacion;
            new bootstrap.Modal(document.getElementById('modalEvidencia')).show();
        }

        // VER EVIDENCIAS
        async function verEvidencias(idAsignacion) {
            try {
                const response = await fetch(`/Sellos/InventarioCoordinador?handler=VerEvidencias&idAsignacion=${idAsignacion}`);
                const html = await response.text();
                document.getElementById('modalVerEvidenciasBody').innerHTML = html;
                new bootstrap.Modal(document.getElementById('modalVerEvidencias')).show();
            } catch (error) {
                Swal.fire('Error', 'No se pudo cargar las evidencias', 'error');
            }
        }

        // ✅ CARGAR OPERADORES (CORREGIDO PARA MODAL)
        async function cargarOperadores() {
            try {
                const response = await fetch('/Sellos/InventarioCoordinador?handler=ListaOperadores');
                const operadores = await response.json();

                // Limpiar opciones anteriores
                $('#modOperador1, #modOperador2').empty();
                $('#modOperador1, #modOperador2').append(new Option('-- Seleccionar --', ''));

                // Llenar select
                operadores.forEach(op => {
                    $('#modOperador1, #modOperador2').append(new Option(op.text, op.value));
                });

                // ✅ SOLUCIÓN CRÍTICA: dropdownParent
                // Esto hace que la lista desplegable se renderice DENTRO del modal y sea visible/clicable
                $('.operador-select').select2({
                    width: '100%',
                    placeholder: '-- Seleccionar Operador --',
                    dropdownParent: $('#modalModificar')
                });

            } catch (error) {
                console.error('Error cargando operadores:', error);
                Swal.fire('Error', 'No se pudo cargar la lista de operadores', 'error');
            }
        }

        // Mostrar/ocultar segundo operador
        document.getElementById('modTipoAsignacion')?.addEventListener('change', function() {
            const container = document.getElementById('modOperador2Container');
            if (this.value == '1') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
                $('#modOperador2').val('').trigger('change');
            }
        });
    </script>
}