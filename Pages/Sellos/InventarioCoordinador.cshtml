@page
@model ProyectoRH2025.Pages.Sellos.InventarioCoordinadorModel
@inject ProyectoRH2025.Services.QRCodeService qrService
@{
    ViewData["Title"] = "Inventario - Coordinador";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<div class="container mt-4">
    <h2 class="mb-4">
        <i class="fas fa-box-open text-primary"></i> Inventario de Sellos - Coordinador
    </h2>

    @if (!string.IsNullOrEmpty(Model.Mensaje))
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i> @Model.Mensaje
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.MensajeError))
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-circle me-2"></i> @Model.MensajeError
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- MOSTRAR QR RECIÉN GENERADO -->
    @if (TempData["MostrarQR"] != null)
    {
        var codigoQR = TempData["MostrarQR"].ToString();
        var qrBase64 = qrService.GenerarQRBase64(codigoQR);

        <div class="alert alert-success shadow-lg">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="alert-heading">
                        <i class="fas fa-check-circle"></i> ¡QR Generado Exitosamente!
                    </h4>
                    <p class="mb-2">El código QR ha sido generado. Imprímelo o muéstralo al operador.</p>
                    <hr />
                    <p class="mb-0"><strong>Código:</strong> <code>@codigoQR</code></p>
                    <p class="mb-0 mt-2">
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-clock"></i> Válido por 1 hora
                        </span>
                    </p>
                </div>
                <div class="col-md-4 text-center">
                    <img src="data:image/png;base64,@qrBase64"
                         alt="Código QR"
                         class="img-fluid"
                         style="max-width: 200px; border: 3px solid #198754; padding: 10px; background: white;" />
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="window.print()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- ✅ TABLA DE SELLOS PRIORITARIOS (3+ DÍAS) -->
    @if (Model.SellosPrioritarios.Any())
    {
        <div class="card shadow mb-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>⚠️ SELLOS PRIORITARIOS - Requieren Seguimiento Urgente
                    <span class="badge bg-dark float-end">@Model.SellosPrioritarios.Count</span>
                </h5>
                <small class="d-block mt-1">
                    <i class="fas fa-info-circle me-1"></i>
                    Sellos con más de 3 días en el mismo estado
                </small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Estado Actual</th>
                                <th>Sello</th>
                                <th>Operador(es)</th>
                                <th>Unidad</th>
                                <th>Días Transcurridos</th>
                                <th>Fecha Inicio</th>
                                <th width="250">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.SellosPrioritarios)
                            {
                                var diasTranscurridos = (int)(DateTime.Now - item.Fentrega).TotalDays;
                                var esEnTramite = item.Status == 4;
                                var esEnUso = item.Status == 3;
                                var fechaReferencia = esEnUso && item.FechaEntrega.HasValue ? item.FechaEntrega.Value : item.Fentrega;

                                <tr class="table-danger">
                                    <td>
                                        @if (esEnTramite)
                                        {
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock"></i> EN TRÁMITE
                                            </span>
                                        }
                                        else if (esEnUso)
                                        {
                                            <span class="badge bg-success">
                                                <i class="fas fa-truck"></i> EN USO
                                            </span>
                                        }
                                    </td>
                                    <td class="fw-bold text-danger">@item.Sello?.Sello</td>
                                    <td>
                                        <div>@item.Operador?.Names @item.Operador?.Apellido</div>
                                        @if (item.TipoAsignacion == 1 && item.Operador2 is not null)
                                        {
                                            <small class="text-muted">
                                                <i class="fas fa-user-friends"></i> + @item.Operador2.Names @item.Operador2.Apellido
                                            </small>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">@item.Unidad?.NumUnidad</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-danger fs-6">
                                            <i class="fas fa-calendar-alt"></i> @diasTranscurridos días
                                        </span>
                                    </td>
                                    <td>
                                        <small>@fechaReferencia.ToString("dd/MM/yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        @if (esEnTramite)
                                        {
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-success"
                                                        onclick="entregarSello(@item.id)"
                                                        title="Entregar">
                                                    <i class="fas fa-check-circle"></i>
                                                </button>
                                                <button class="btn btn-primary"
                                                        onclick="modificarAsignacion(@item.id)"
                                                        title="Modificar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        }
                                        else if (esEnUso)
                                        {
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-warning"
                                                        onclick="devolverSello(@item.id)"
                                                        title="Devolver">
                                                    <i class="fas fa-undo"></i>
                                                </button>
                                                <button class="btn btn-info"
                                                        onclick="subirEvidencia(@item.id)"
                                                        title="Evidencia">
                                                    <i class="fas fa-camera"></i>
                                                </button>
                                                <button class="btn btn-secondary"
                                                        onclick="verEvidencias(@item.id)"
                                                        title="Ver Evidencias">
                                                    <i class="fas fa-images"></i>
                                                </button>
                                            </div>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- TABLA DE SELLOS EN TRÁMITE -->
    <div class="card shadow mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
                <i class="fas fa-clock me-2"></i>Sellos en Trámite (Status 4)
                <span class="badge bg-dark float-end">@Model.SellosEnTramite.Count</span>
            </h5>
        </div>
        <div class="card-body">
            @if (Model.SellosEnTramite.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Sello</th>
                                <th>Operador(es)</th>
                                <th>Unidad</th>
                                <th>Ruta</th>
                                <th>Tipo</th>
                                <th>Supervisor</th>
                                <th>Fecha Asignación</th>
                                <th width="200">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.SellosEnTramite)
                            {
                                var diasTranscurridos = (int)(DateTime.Now - item.Fentrega).TotalDays;
                                var esPrioritario = diasTranscurridos >= 3;

                                <tr class="@(esPrioritario ? "table-warning" : "")">
                                    <td>
                                        <span class="fw-bold text-primary">@item.Sello?.Sello</span>
                                        @if (esPrioritario)
                                        {
                                            <br />
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-exclamation-triangle"></i> @diasTranscurridos días
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <div>@item.Operador?.Names @item.Operador?.Apellido</div>
                                        @if (item.TipoAsignacion == 1 && item.Operador2 is not null)
                                        {
                                            <small class="text-muted">
                                                <i class="fas fa-user-friends"></i> + @item.Operador2.Names @item.Operador2.Apellido
                                            </small>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">@item.Unidad?.NumUnidad</span>
                                    </td>
                                    <td>@item.Ruta</td>
                                    <td>
                                        <span class="badge bg-info">
                                            @(item.TipoAsignacion == 1 ? "Comboy" : "Individual")
                                        </span>
                                    </td>
                                    <td>
                                        <small>@item.Usuario?.UsuarioNombre</small>
                                    </td>
                                    <td>
                                        <small>@item.Fentrega.ToString("dd/MM/yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-success"
                                                    onclick="entregarSello(@item.id)"
                                                    title="Entregar">
                                                <i class="fas fa-check-circle"></i>
                                            </button>
                                            <button class="btn btn-primary"
                                                    onclick="modificarAsignacion(@item.id)"
                                                    title="Modificar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-5">
                    <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                    <p class="mb-0">No hay sellos en trámite</p>
                </div>
            }
        </div>
    </div>

    <!-- TABLA DE SELLOS EN USO -->
    <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="fas fa-truck me-2"></i>Sellos En Uso (Status 3)
                <span class="badge bg-dark float-end">@Model.SellosEnUso.Count</span>
            </h5>
        </div>
        <div class="card-body">
            @if (Model.SellosEnUso.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Sello</th>
                                <th>Operador(es)</th>
                                <th>Unidad</th>
                                <th>QR Code</th>
                                <th>Fecha Entrega</th>
                                <th>Status Evidencia</th>
                                <th width="250">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.SellosEnUso)
                            {
                                var diasTranscurridos = item.FechaEntrega.HasValue ? (int)(DateTime.Now - item.FechaEntrega.Value).TotalDays : 0;
                                var esPrioritario = diasTranscurridos >= 3;

                                <tr class="@(esPrioritario ? "table-warning" : "")">
                                    <td>
                                        <span class="fw-bold text-success">@item.Sello?.Sello</span>
                                        @if (esPrioritario)
                                        {
                                            <br />
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-exclamation-triangle"></i> @diasTranscurridos días
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <div>@item.Operador?.Names @item.Operador?.Apellido</div>
                                        @if (item.TipoAsignacion == 1 && item.Operador2 is not null)
                                        {
                                            <small class="text-muted">
                                                <i class="fas fa-user-friends"></i> + @item.Operador2.Names @item.Operador2.Apellido
                                            </small>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">@item.Unidad?.NumUnidad</span>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary"
                                                onclick="verQR(@item.id)"
                                                title="Ver QR">
                                            <i class="fas fa-qrcode"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <small>@(item.FechaEntrega?.ToString("dd/MM/yyyy HH:mm") ?? "-")</small>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(item.StatusEvidencia))
                                        {
                                            <span class="badge bg-info">@item.StatusEvidencia</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-warning"
                                                    onclick="devolverSello(@item.id)"
                                                    title="Devolver">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                            <button class="btn btn-info"
                                                    onclick="subirEvidencia(@item.id)"
                                                    title="Evidencia">
                                                <i class="fas fa-camera"></i>
                                            </button>
                                            <button class="btn btn-secondary"
                                                    onclick="verEvidencias(@item.id)"
                                                    title="Ver Evidencias">
                                                <i class="fas fa-images"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-5">
                    <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                    <p class="mb-0">No hay sellos en uso</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- MODAL: ENTREGAR SELLO -->
<div class="modal fade" id="modalEntregar" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Confirmar Entrega
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalEntregarBody">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: MODIFICAR ASIGNACIÓN -->
<div class="modal fade" id="modalModificar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Modificar Operador(es)
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-page-handler="ModificarOperador">
                <div class="modal-body">
                    <input type="hidden" id="modIdAsignacion" name="IdAsignacion" />

                    <div class="mb-3">
                        <label class="form-label">Tipo de Asignación</label>
                        <select id="modTipoAsignacion" name="TipoAsignacion" class="form-select">
                            <option value="0">Individual</option>
                            <option value="1">Comboy</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Operador Principal</label>
                        <select id="modOperador1" name="IdOperador" class="form-select operador-select" required></select>
                    </div>

                    <div class="mb-3" id="modOperador2Container" style="display: none;">
                        <label class="form-label">Segundo Operador</label>
                        <select id="modOperador2" name="IdOperador2" class="form-select operador-select"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: VER QR -->
<div class="modal fade" id="modalQR" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-qrcode me-2"></i>Código QR
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="modalQRBody">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: DEVOLVER SELLO -->
<div class="modal fade" id="modalDevolver" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-undo me-2"></i>Devolver Sello
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-page-handler="DevolverSello">
                <div class="modal-body">
                    <input type="hidden" id="devIdAsignacion" name="IdAsignacion" />

                    <div class="mb-3">
                        <label class="form-label">Escanear o Ingresar Código QR</label>
                        <input type="text" name="CodigoQR" class="form-control"
                               placeholder="ASIG-XXX-SELLO-XXX..."
                               required
                               autocomplete="off" />
                        <small class="form-text text-muted">
                            Formato: ASIG-{id}-SELLO-{numero}-OP-{id}-{timestamp}
                        </small>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Importante:</strong> El código QR debe coincidir exactamente con el sello y operador asignados.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-check"></i> Procesar Devolución
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: SUBIR EVIDENCIA - MÚLTIPLES IMÁGENES -->
<div class="modal fade" id="modalEvidencia" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-camera me-2"></i>Subir Evidencia
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" enctype="multipart/form-data" asp-page-handler="SubirEvidencia">
                <div class="modal-body">
                    <input type="hidden" id="evIdAsignacion" name="IdAsignacion" />

                    <div class="mb-3">
                        <label class="form-label">Tipo de Evidencia</label>
                        <select name="TipoEvidencia" class="form-select" required>
                            <option value="">-- Seleccionar --</option>
                            <option value="Utilizado">✅ Sello Utilizado</option>
                            <option value="Defectuoso">⚠️ Sello Defectuoso</option>
                            <option value="Planta">🏭 Se quedó en Planta</option>
                            <option value="Extraviado">❌ Sello Extraviado</option>
                            <option value="Otro">📝 Otro</option>
                        </select>
                    </div>

                    <!-- ✅ MÚLTIPLES ARCHIVOS -->
                    <div class="mb-3">
                        <label class="form-label">Fotos de Evidencia (Mínimo 1, Máximo 3)</label>
                        <input type="file"
                               name="ArchivosEvidencia"
                               class="form-control"
                               accept="image/*"
                               multiple
                               required
                               id="inputEvidencias"
                               onchange="validarCantidadArchivos()" />
                        <small class="form-text text-muted">
                            Formatos: JPG, PNG (Máx. 10MB por imagen)
                        </small>
                        <div id="contadorArchivos" class="mt-2"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Comentarios</label>
                        <textarea name="Comentarios" class="form-control" rows="3"
                                  placeholder="Describe los detalles de la evidencia..."></textarea>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Nota:</strong> El status del sello se actualizará automáticamente según el tipo de evidencia.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info" id="btnSubirEvidencia">
                        <i class="fas fa-upload"></i> Subir Evidencia
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: VER EVIDENCIAS -->
<div class="modal fade" id="modalVerEvidencias" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-images me-2"></i>Evidencias Registradas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalVerEvidenciasBody">
                <div class="text-center">
                    <div class="spinner-border text-secondary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ✅ VALIDAR CANTIDAD DE ARCHIVOS (1-3)
        function validarCantidadArchivos() {
            const input = document.getElementById('inputEvidencias');
            const contador = document.getElementById('contadorArchivos');
            const btnSubmit = document.getElementById('btnSubirEvidencia');

            const archivos = input.files;
            const cantidad = archivos.length;

            if (cantidad < 1) {
                contador.innerHTML = '<span class="badge bg-danger">⚠️ Debes seleccionar al menos 1 imagen</span>';
                btnSubmit.disabled = true;
                return;
            }

            if (cantidad > 3) {
                contador.innerHTML = '<span class="badge bg-danger">⚠️ Máximo 3 imágenes permitidas</span>';
                btnSubmit.disabled = true;
                input.value = '';
                return;
            }

            // Validar tamaño de cada archivo
            let hayError = false;
            for (let i = 0; i < archivos.length; i++) {
                if (archivos[i].size > 10 * 1024 * 1024) {
                    contador.innerHTML = `<span class="badge bg-danger">⚠️ El archivo "${archivos[i].name}" supera 10MB</span>`;
                    btnSubmit.disabled = true;
                    hayError = true;
                    break;
                }
            }

            if (!hayError) {
                contador.innerHTML = `<span class="badge bg-success">✅ ${cantidad} imagen(es) seleccionada(s)</span>`;
                btnSubmit.disabled = false;
            }
        }

        // ENTREGAR SELLO - Cargar confirmación
        async function entregarSello(idAsignacion) {
            try {
                const response = await fetch(`/Sellos/InventarioCoordinador?handler=ConfirmarEntrega&idAsignacion=${idAsignacion}`);
                const html = await response.text();
                document.getElementById('modalEntregarBody').innerHTML = html;
                new bootstrap.Modal(document.getElementById('modalEntregar')).show();
            } catch (error) {
                Swal.fire('Error', 'No se pudo cargar la información', 'error');
            }
        }

        // MODIFICAR ASIGNACIÓN
        async function modificarAsignacion(idAsignacion) {
            try {
                const response = await fetch(`/Sellos/InventarioCoordinador?handler=ObtenerAsignacion&idAsignacion=${idAsignacion}`);
                const data = await response.json();

                if (data.error) {
                    Swal.fire('Error', data.error, 'error');
                    return;
                }

                document.getElementById('modIdAsignacion').value = idAsignacion;
                document.getElementById('modTipoAsignacion').value = data.tipoAsignacion;

                await cargarOperadores();

                setTimeout(() => {
                    $('#modOperador1').val(data.idOperador).trigger('change');

                    if (data.tipoAsignacion == 1 && data.idOperador2) {
                        $('#modOperador2').val(data.idOperador2).trigger('change');
                        document.getElementById('modOperador2Container').style.display = 'block';
                    } else {
                        document.getElementById('modOperador2Container').style.display = 'none';
                        $('#modOperador2').val('').trigger('change');
                    }
                }, 100);

                new bootstrap.Modal(document.getElementById('modalModificar')).show();
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'No se pudo cargar la información', 'error');
            }
        }

        // VER QR
        async function verQR(idAsignacion) {
            try {
                const response = await fetch(`/Sellos/InventarioCoordinador?handler=VerQR&idAsignacion=${idAsignacion}`);
                const html = await response.text();
                document.getElementById('modalQRBody').innerHTML = html;
                new bootstrap.Modal(document.getElementById('modalQR')).show();
            } catch (error) {
                Swal.fire('Error', 'No se pudo cargar el QR', 'error');
            }
        }

        // DEVOLVER SELLO
        function devolverSello(idAsignacion) {
            document.getElementById('devIdAsignacion').value = idAsignacion;
            new bootstrap.Modal(document.getElementById('modalDevolver')).show();
        }

        // SUBIR EVIDENCIA
        function subirEvidencia(idAsignacion) {
            document.getElementById('evIdAsignacion').value = idAsignacion;
            new bootstrap.Modal(document.getElementById('modalEvidencia')).show();
        }

        // VER EVIDENCIAS
        async function verEvidencias(idAsignacion) {
            try {
                const response = await fetch(`/Sellos/InventarioCoordinador?handler=VerEvidencias&idAsignacion=${idAsignacion}`);
                const html = await response.text();
                document.getElementById('modalVerEvidenciasBody').innerHTML = html;
                new bootstrap.Modal(document.getElementById('modalVerEvidencias')).show();
            } catch (error) {
                Swal.fire('Error', 'No se pudo cargar las evidencias', 'error');
            }
        }

        // CARGAR OPERADORES
        async function cargarOperadores() {
            try {
                const response = await fetch('/Sellos/InventarioCoordinador?handler=ListaOperadores');
                const operadores = await response.json();

                $('#modOperador1, #modOperador2').empty();
                $('#modOperador1, #modOperador2').append(new Option('-- Seleccionar --', ''));

                operadores.forEach(op => {
                    $('#modOperador1, #modOperador2').append(new Option(op.text, op.value));
                });

                $('.operador-select').select2({
                    width: '100%',
                    placeholder: '-- Seleccionar Operador --',
                    dropdownParent: $('#modalModificar')
                });

            } catch (error) {
                console.error('Error cargando operadores:', error);
                Swal.fire('Error', 'No se pudo cargar la lista de operadores', 'error');
            }
        }

        // Mostrar/ocultar segundo operador
        document.getElementById('modTipoAsignacion')?.addEventListener('change', function() {
            const container = document.getElementById('modOperador2Container');
            if (this.value == '1') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
                $('#modOperador2').val('').trigger('change');
            }
        });
    </script>
}
