@page
@model ProyectoRH2025.Pages.Sellos.GestionSellosModel
@{
    ViewData["Title"] = "Gestión de Sellos";
}

<style>
    :root {
        --primary-green: #16a34a;
        --primary-purple: #7c3aed;
        --primary-blue: #2563eb;
        --primary-orange: #ea580c;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
        --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
        --shadow-lg: 0 8px 32px rgba(0,0,0,0.16);
    }

    body {
        background: #f8f9fa;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .dashboard-header {
        background: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-sm);
    }

    .dashboard-title {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: -0.5px;
    }

    /* Stats Cards */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
        }

        .stat-card.green::before {
            background: var(--primary-green);
        }

        .stat-card.purple::before {
            background: var(--primary-purple);
        }

        .stat-card.blue::before {
            background: var(--primary-blue);
        }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: white;
    }

        .stat-icon.green {
            background: var(--primary-green);
        }

        .stat-icon.purple {
            background: var(--primary-purple);
        }

        .stat-icon.blue {
            background: var(--primary-blue);
        }

    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
        letter-spacing: 0.5px;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1f2937;
        line-height: 1;
    }

    /* Action Buttons */
    .actions-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .action-btn {
        background: white;
        border: none;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        color: white;
        font-weight: 600;
        font-size: 1rem;
    }

        .action-btn:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .action-btn.green {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        }

        .action-btn.blue {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .action-btn.orange {
            background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
        }

        .action-btn.purple {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }

    .action-icon {
        font-size: 2rem;
    }

    /* Tables Container */
    .tables-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 1.5rem;
    }

    .table-card {
        background: white;
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }

    .table-header {
        background: #f9fafb;
        padding: 1.25rem 1.5rem;
        border-bottom: 2px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: -0.3px;
    }

    .download-btn {
        background: #e5e7eb;
        border: none;
        border-radius: 8px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
        color: #6b7280;
    }

        .download-btn:hover {
            background: #d1d5db;
        }

    .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

        .modern-table thead {
            background: #f9fafb;
        }

        .modern-table th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modern-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
            font-size: 0.9rem;
        }

        .modern-table tbody tr:hover {
            background: #f9fafb;
        }

    .status-badge {
        display: inline-block;
        padding: 0.375rem 0.875rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: capitalize;
    }

        .status-badge.available {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.assigned {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

    /* Modal Styles */
    .modal-content {
        border: none;
        border-radius: 16px;
        box-shadow: var(--shadow-lg);
    }

    .modal-header {
        border-bottom: 2px solid #e5e7eb;
        padding: 1.5rem;
    }

    .modal-title {
        font-weight: 700;
        color: #1f2937;
    }

    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .form-control, .form-select {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 0.75rem;
        transition: border-color 0.2s;
    }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

    .btn-modern {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        border: none;
        transition: all 0.2s;
    }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-modern.green {
            background: var(--primary-green);
            color: white;
        }

        .btn-modern.blue {
            background: var(--primary-blue);
            color: white;
        }

        .btn-modern.orange {
            background: var(--primary-orange);
            color: white;
        }

    .alert-modern {
        border: none;
        border-radius: 12px;
        padding: 1rem 1.5rem;
        box-shadow: var(--shadow-sm);
    }

    /* Estilos para checkboxes */
    .sello-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

        .sello-checkbox:hover {
            transform: scale(1.1);
        }

    /* Fila seleccionada resaltada */
    .modern-table tbody tr:has(.sello-checkbox:checked) {
        background: #fef3c7 !important;
    }

    /* Botón de desasignar mejorado */
    .btn-danger {
        background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
        color: white;
        font-weight: 600;
        padding: 0.5rem 1rem;
        border: none;
        transition: all 0.2s;
    }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
        }

        .btn-danger.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
</style>

<div class="dashboard-header">
    <div class="container">
        <h1 class="dashboard-title">📦 Gestión de Sellos - Dashboard</h1>
    </div>
</div>

<div class="container">
    @if (TempData["MensajeExito"] != null)
    {
        <div class="alert alert-success alert-modern alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i> @TempData["MensajeExito"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["MensajeError"] != null)
    {
        <div class="alert alert-danger alert-modern alert-dismissible fade show">
            <i class="fas fa-exclamation-circle me-2"></i> @TempData["MensajeError"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="stats-container">
        <div class="stat-card green">
            <div class="stat-icon green">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="stat-label">Total de Sellos</div>
            <div class="stat-value">@Model.ListaSellos.Count</div>
        </div>

        <div class="stat-card purple">
            <div class="stat-icon purple">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-label">Sellos Disponibles</div>
            <div class="stat-value">@Model.ListaSellos.Count(s => s.Status == 1)</div>
        </div>

        <div class="stat-card blue">
            <div class="stat-icon blue">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-label">Sellos Asignados</div>
            <div class="stat-value">@Model.ListaSellos.Count(s => s.Status == 14)</div>
        </div>
    </div>

    <div class="actions-container">
        <button class="action-btn green" data-bs-toggle="modal" data-bs-target="#importModal">
            <div class="action-icon">🏛️</div>
            <div>IMPORTAR SELLOS</div>
        </button>

        <button class="action-btn blue" data-bs-toggle="modal" data-bs-target="#assignModal">
            <div class="action-icon">🔄</div>
            <div>ASIGNAR SELLO</div>
        </button>

        <button class="action-btn orange" data-bs-toggle="modal" data-bs-target="#unassignModal">
            <div class="action-icon">❌</div>
            <div>DESASIGNAR SELLO</div>
        </button>

        <button class="action-btn purple" onclick="window.location.href='/Sellos/HistorialSellos'">
            <div class="action-icon">📊</div>
            <div>VER HISTORIAL</div>
        </button>
    </div>

    <div class="tables-container">
        <!-- TABLA DE SELLOS DISPONIBLES -->
        <div class="table-card">
            <div class="table-header">
                <h3 class="table-title">Sellos Disponibles (@Model.ListaSellos.Count(s => s.Status == 1))</h3>
                <button class="download-btn" onclick="downloadAvailable()">
                    <i class="fas fa-download"></i>
                </button>
            </div>
            <div class="table-responsive">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Sello</th>
                            <th>Fecha Entrega</th>
                            <th>Recibió</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.ListaSellos.Any(s => s.Status == 1))
                        {
                            @foreach (var item in Model.ListaSellos.Where(s => s.Status == 1))
                            {
                                <tr>
                                    <td class="fw-bold">@item.Sello</td>
                                    <td>@(item.Fentrega?.ToString("dd/MM/yyyy") ?? "-")</td>
                                    <td>@(item.Recibio ?? "-")</td>
                                    <td><span class="status-badge available">Disponible</span></td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2"></i>
                                    <div>No hay sellos disponibles</div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TABLA DE SELLOS ASIGNADOS CON CHECKBOXES -->
        <div class="table-card">
            <div class="table-header">
                <h3 class="table-title">Sellos Asignados (@Model.ListaSellos.Count(s => s.Status == 14))</h3>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-danger" onclick="desasignarSeleccionados()" style="border-radius: 8px;">
                        <i class="fas fa-times-circle me-1"></i> Desasignar Seleccionados
                    </button>
                    <button class="download-btn" onclick="downloadAssigned()">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <form id="formDesasignarSeleccionados" method="post" asp-page-handler="DesasignarSeleccionados">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th width="50" class="text-center">
                                    <input type="checkbox" id="selectAllAssigned" onclick="toggleSelectAll(this)"
                                           title="Seleccionar todos">
                                </th>
                                <th>Sello</th>
                                <th>Asignado a</th>
                                <th>Fecha Asignación</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.ListaSellos.Any(s => s.Status == 14))
                            {
                                var index = 0;
                                @foreach (var item in Model.ListaSellos.Where(s => s.Status == 14))
                                {
                                    <tr>
                                        <td class="text-center">
                                            <input type="checkbox"
                                                   name="SellosSeleccionados"
                                                   value="@item.Id"
                                                   class="sello-checkbox form-check-input"
                                                   style="cursor: pointer;">
                                        </td>
                                        <td class="fw-bold">@item.Sello</td>
                                        <td>@(item.Supervisor?.NombreCompleto ?? item.Supervisor?.UsuarioNombre ?? "Sin Supervisor")</td>
                                        <td>@(item.FechaAsignacion?.ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
                                        <td><span class="status-badge assigned">Asignado</span></td>
                                    </tr>
                                    index++;
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i>
                                        <div>No hay sellos asignados</div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL ASIGNAR SELLOS -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-labelledby="assignModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignModalLabel">🔄 Asignar Sellos a Supervisor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" asp-page-handler="Asignar">
                    <div class="mb-3">
                        <label class="form-label">Seleccionar Supervisor</label>
                        <select asp-for="SupervisorSeleccionadoId" asp-items="Model.ListaSupervisores" class="form-select">
                            <option value="">-- Seleccionar Supervisor --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Cantidad de Sellos</label>
                        <input asp-for="CantidadAsignar" type="number" min="1" class="form-control" placeholder="Ingresa la cantidad" />
                    </div>

                    <div class="alert alert-info alert-modern">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>El sistema asignará sellos no consecutivos automáticamente.</small>
                    </div>

                    <button type="submit" class="btn btn-modern blue w-100">
                        <i class="fas fa-random me-2"></i> Asignar Aleatoriamente
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL IMPORTAR SELLOS -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">🏛️ Importar Sellos (Excel)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" asp-page-handler="Importar">
                    <div class="mb-3">
                        <label class="form-label">Archivo Excel (.xlsx)</label>
                        <input type="file" asp-for="ArchivoExcel" class="form-control" accept=".xlsx, .xls" />
                        <small class="text-muted">Formato: Columna 1: Número Sello | Columna 2: Fecha | Columna 3: Recibió</small>
                    </div>

                    <button type="submit" class="btn btn-modern green w-100">
                        <i class="fas fa-upload me-2"></i> Subir e Importar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DESASIGNAR SELLOS POR SUPERVISOR -->
<div class="modal fade" id="unassignModal" tabindex="-1" aria-labelledby="unassignModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="unassignModalLabel">❌ Desasignar Sellos de Supervisor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" asp-page-handler="DesasignarPorSupervisor">
                    <div class="mb-3">
                        <label class="form-label">Seleccionar Supervisor</label>
                        <select asp-for="SupervisorADesasignar" asp-items="Model.ListaSupervisores" class="form-select">
                            <option value="">-- Seleccionar Supervisor --</option>
                        </select>
                    </div>

                    <div class="alert alert-warning alert-modern">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <small>Se desasignarán TODOS los sellos del supervisor seleccionado y quedarán registrados en el historial.</small>
                    </div>

                    <button type="submit" class="btn btn-modern orange w-100">
                        <i class="fas fa-times-circle me-2"></i> Desasignar Todos los Sellos
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Función para seleccionar/deseleccionar todos los checkboxes
        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.sello-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            actualizarContadorSeleccionados();
        }

        // Función para desasignar sellos seleccionados
        function desasignarSeleccionados() {
            const form = document.getElementById('formDesasignarSeleccionados');
            const checkboxes = document.querySelectorAll('.sello-checkbox:checked');

            if (checkboxes.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Sin Selección',
                    text: 'Selecciona al menos un sello para desasignar.',
                    confirmButtonColor: '#ea580c'
                });
                return;
            }

            let sellosTexto = '';
            checkboxes.forEach((cb, index) => {
                const fila = cb.closest('tr');
                const numeroSello = fila.querySelector('td:nth-child(2)').textContent;
                sellosTexto += numeroSello + (index < checkboxes.length - 1 ? ', ' : '');
            });

            Swal.fire({
                title: '¿Confirmar Desasignación?',
                html: `
                    <div class="text-start">
                        <p class="mb-2">Vas a desasignar <strong>${checkboxes.length}</strong> sello(s):</p>
                        <div class="alert alert-info">
                            ${sellosTexto}
                        </div>
                        <p class="text-muted small mb-0">Esta acción quedará registrada en el historial.</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ea580c',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Sí, desasignar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.sello-checkbox');
            const selectAll = document.getElementById('selectAllAssigned');

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const todosSeleccionados = Array.from(checkboxes).every(cb => cb.checked);
                    const algunoSeleccionado = Array.from(checkboxes).some(cb => cb.checked);

                    if (selectAll) {
                        selectAll.checked = todosSeleccionados;
                        selectAll.indeterminate = algunoSeleccionado && !todosSeleccionados;
                    }

                    actualizarContadorSeleccionados();
                });
            });
        });

        function actualizarContadorSeleccionados() {
            const checkboxes = document.querySelectorAll('.sello-checkbox:checked');
            const botonDesasignar = document.querySelector('.btn-danger');

            if (botonDesasignar) {
                if (checkboxes.length > 0) {
                    botonDesasignar.innerHTML = `<i class="fas fa-times-circle me-1"></i> Desasignar (${checkboxes.length})`;
                    botonDesasignar.classList.remove('disabled');
                } else {
                    botonDesasignar.innerHTML = '<i class="fas fa-times-circle me-1"></i> Desasignar Seleccionados';
                }
            }
        }

        function downloadAvailable() {
            alert('Descargando lista de sellos disponibles...');
        }

        function downloadAssigned() {
            alert('Descargando lista de sellos asignados...');
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
}